{"version":3,"sources":["../libs/factory.js"],"names":[],"mappings":"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","file":"libs/factory.js","sourcesContent":["import url from 'url'\nimport _ from 'lodash'\nimport debug from 'debug'\nimport request from 'request'\nimport urlmaker from './url'\n\nexport function lowLevel(host, method, rules) {\n  return (url, params, callback) => {\n    if (!url) \n      return false;\n\n    return initRequest({\n      host,\n      url,\n      method,\n      rules,\n    }, params, callback);\n  };\n}\n\nexport function highLevel(host, route, rules) {\n  return (params, callback) => {\n    return initRequest({\n      host,\n      rules,\n      url: urlmaker(route.url, params || {}),\n      method: route.method ? route.method.toLowerCase() : 'get',\n    }, params, callback, (err, res, body, done) => {\n      if (route.callback && _.isFunction(route.callback))\n        return route.callback(err, res, body, done);\n\n      return done(err, res, body);\n    });\n  };\n}\n\nfunction initRequest(opts, params, callback, next) {\n  var rules = opts.rules;\n  var done = retCallback(params, callback);\n  var options = isObject(params) ? params : {};\n\n  if (rules) {\n    if (rules.all) \n      options = _.merge(_.cloneDeep(rules.all), options);\n    if (rules[opts.method])\n      options = _.merge(_.cloneDeep(rules[opts.method]), options);\n  }\n\n  options.url = isAbsUri(opts.url) ? \n    opts.url : url.resolve(opts.host, opts.url);\n\n  options.method = opts.method;\n\n  if (options.json == undefined)\n    options.json = true;\n\n  debug('sdk:request')(options);\n\n  return request(options, (err, res, body) => {\n    return defaultCallback(err, res, body);\n  });\n\n  function defaultCallback(err, res, body) {\n    var cb = next || done;\n    if (err) {\n      debug('sdk:response:error')(err);\n      return cb(err, res, null, done);\n    }\n\n    debug('sdk:response:status')(res.statusCode);\n    debug('sdk:response:headers')(res['headers']);\n    debug('sdk:response:body')(body);\n\n    var code = res.statusCode;\n    if (code !== 200) \n      return cb(new Error(code), res, body, done);\n\n    return cb(null, res, body, done);\n  }\n}\n\nfunction retCallback(params, callback) {\n  if (!params && !callback) \n    return emptyCallback;\n  if (_.isFunction(params) && !callback) \n    return params;\n  if (callback && _.isFunction(callback)) \n    return callback;\n\n  return emptyCallback;\n\n  function emptyCallback(){}\n}\n\nfunction isObject(obj) {\n  return obj && _.isObject(obj) && !_.isFunction(obj);\n}\n\nfunction isAbsUri(uri) {\n  return uri && (uri.indexOf('http') === 0 || uri.indexOf('https') === 0);\n}\n"]}