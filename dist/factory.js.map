{"version":3,"sources":["../libs/factory.js"],"names":[],"mappings":"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","file":"factory.js","sourcesContent":["import url from 'url'\nimport _ from 'lodash'\nimport debug from 'debug'\nimport Promise from 'bluebird'\nimport request from 'superagent'\nimport urlmaker from './url'\nimport fetch from 'isomorphic-fetch'\n\nexport function lowLevel(host, method, rules) {\n  return (url, params={}) => {\n    // Return a Promise/A+\n    return initRequest({\n      host,\n      url,\n      method,\n      rules,\n    }, params)\n  }\n}\n\nexport function highLevel(host, { url, method, callback }, rules) {\n  return (params={}) => {\n    // Return a Promise/A+\n    return initRequest({\n      host,\n      rules,\n      url: urlmaker(url, params),\n      method: method ? method.toLowerCase() : 'get',\n    }, params, callback)\n  }\n}\n\nasync function initRequest(opts, params, middleware) {\n  var rules = opts.rules\n  var options = isObject(params) ? params : {}\n\n  if (rules) {\n    if (rules.all)\n      options = _.merge(_.cloneDeep(rules.all), options)\n    if (rules[opts.method])\n      options = _.merge(_.cloneDeep(rules[opts.method]), options)\n\n    if (options.headers) {\n      Object.keys(options.headers).forEach(k => {\n        if (typeof(options.headers[k]) === 'function')\n          options.headers[k] = options.headers[k]()\n      })\n    }\n  }\n\n  options.method = opts.method\n  options.url = isAbsUri(opts.url) ?\n    opts.url : url.resolve(opts.host, opts.url);\n\n  if (options.json == undefined)\n    options.json = true\n\n  if (options.json)\n    options.headers = {\n      ...options.headers,\n      'Content-Type': 'application/json'\n    }\n\n  debug('sdk:request')(options)\n\n  const search = Object.keys(options.qs).map(key => {\n    return key + '=' + obj[key];\n  }).join('&');\n\n  try {\n    let response = await fetch(`${options.url}${search}`, {\n      method: options.method,\n      headers: options.headers,\n      body: options.body\n    });\n\n    if (response.status === 200) return response.json()\n    throw response;\n  } catch (error) {\n    throw error;\n  }\n\n  // return new Promise((Resolve, Reject) => {\n  //   let req = request[options.method](options.url);\n\n  //   if (options.headers)\n  //     req.set(options.headers)\n  //   if (options.json)\n  //     req.accept('json').type('json')\n  //   if (options.qs)\n  //     req.query(options.qs)\n  //   if (options.body)\n  //     req.send(options.body)\n\n  //   req.end((err, res) => {\n  //     // We need the whole response\n  //     if (err)\n  //       return Reject(res)\n\n  //     debug('sdk:response:status')(res.status)\n  //     debug('sdk:response:headers')(res.header)\n  //     debug('sdk:response:body')(res.body)\n\n  //     let code = res.status;\n  //     let body = res.body || res.text;\n\n  //     if (_.isFunction(middleware)) {\n  //       return middleware(res, body, (customError, customBody) => {\n  //         if (customError)\n  //           return Reject(customError)\n\n  //         return Resolve({\n  //           code,\n  //           response: res,\n  //           body: customBody || body\n  //         })\n  //       })\n  //     }\n\n  //     return Resolve({\n  //       code,\n  //       response: res,\n  //       body\n  //     })\n  //   })\n\n  //   return req\n  // })\n}\n\nfunction isObject(obj) {\n  return obj && _.isObject(obj) && !_.isFunction(obj)\n}\n\nfunction isAbsUri(uri) {\n  return uri && (uri.indexOf('http') === 0 || uri.indexOf('https') === 0)\n}\n"]}