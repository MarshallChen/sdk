{"version":3,"sources":["../libs/factory.js"],"names":[],"mappings":"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","file":"factory.js","sourcesContent":["import url from 'url'\nimport _ from 'lodash'\nimport debug from 'debug'\nimport Promise from 'bluebird'\nimport request from 'superagent'\nimport urlmaker from './url'\n\nexport function lowLevel(host, method, rules) {\n  return (url, params={}) => {\n    // Return a Promise/A+\n    return initRequest({\n      host,\n      url,\n      method,\n      rules,\n    }, params)\n  }\n}\n\nexport function highLevel(host, { url, method, callback }, rules) {\n  return (params={}) => {\n    // Return a Promise/A+\n    return initRequest({\n      host,\n      rules,\n      url: urlmaker(url, params),\n      method: method ? method.toLowerCase() : 'get',\n    }, params, callback)\n  }\n}\n\nfunction initRequest(opts, params, middleware) {\n  var rules = opts.rules\n  var options = isObject(params) ? params : {}\n\n  if (rules) {\n    if (rules.all)\n      options = _.merge(_.cloneDeep(rules.all), options)\n    if (rules[opts.method])\n      options = _.merge(_.cloneDeep(rules[opts.method]), options)\n\n    if (options.headers) {\n      Object.keys(options.headers).forEach(k => {\n        if (typeof(options.headers[k]) === 'function')\n          options.headers[k] = options.headers[k]()\n      })\n    }\n  }\n\n  options.method = opts.method\n  options.url = isAbsUri(opts.url) ?\n    opts.url : url.resolve(opts.host, opts.url);\n\n  if (options.json == undefined)\n    options.json = true\n\n  debug('sdk:request')(options)\n\n  return new Promise((Resolve, Reject) => {\n    let req = request[options.method](options.url)\n\n    if (options.headers)\n      req.set(options.headers)\n    if (options.json)\n      req.accept('json').type('json')\n    if (options.qs)\n      req.query(options.qs)\n    if (options.body)\n      req.send(options.body)\n\n    req.end((err, res) => {\n      // We need the whole response\n      if (err)\n        return Reject(res)\n\n      debug('sdk:response:status')(res.status)\n      debug('sdk:response:headers')(res.header)\n      debug('sdk:response:body')(res.body)\n\n      let code = res.status;\n      let body = res.body || res.text;\n\n      if (_.isFunction(middleware)) {\n        return middleware(res, body, (customError, customBody) => {\n          if (customError)\n            return Reject(customError)\n\n          return Resolve({\n            code,\n            response: res,\n            body: customBody || body\n          })\n        })\n      }\n\n      return Resolve({\n        code,\n        response: res,\n        body\n      })\n    })\n  })\n}\n\nfunction isObject(obj) {\n  return obj && _.isObject(obj) && !_.isFunction(obj)\n}\n\nfunction isAbsUri(uri) {\n  return uri && (uri.indexOf('http') === 0 || uri.indexOf('https') === 0)\n}\n"]}